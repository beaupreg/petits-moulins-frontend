<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Les Petits Moulins - Syst√®me d'Autorisation</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: linear-gradient(135deg, #a8d5ba 0%, #7fb069 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            color: #2c3e50;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(44, 62, 80, 0.1);
            border-radius: 10px;
            padding: 10px;
            backdrop-filter: blur(10px);
        }

        .nav-tab {
            background: transparent;
            border: none;
            color: #2c3e50;
            padding: 12px 24px;
            margin: 0 5px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-tab:hover {
            background: rgba(44, 62, 80, 0.15);
        }

        .nav-tab.active {
            background: rgba(44, 62, 80, 0.2);
            box-shadow: 0 4px 15px rgba(44, 62, 80, 0.2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-card, .dashboard-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #7fb069;
            box-shadow: 0 0 0 3px rgba(127, 176, 105, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #7fb069 0%, #5d8a4a 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(127, 176, 105, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #b8860b 0%, #daa520 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
        }

        .success-message {
            background: #d5f4e6;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #27ae60;
        }

        .verification-code-input {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .verification-code-input input {
            width: 50px !important;
            height: 50px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
        }

        .parent-info {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #7fb069;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            transform: scale(1.2);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            max-width: 400px;
        }

        .status-info {
            background: #3498db;
        }

        .status-success {
            background: #27ae60;
        }

        .status-error {
            background: #e74c3c;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .child-association {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #3498db;
        }

        .child-info {
            flex: 1;
        }

        .relationship-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .custody-shared {
            background: #e8f5e8;
            color: #2e7d2e;
        }

        .custody-primary {
            background: #fff3cd;
            color: #856404;
        }

        .custody-secondary {
            background: #cce7ff;
            color: #004085;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                margin: 5px 0;
            }
            
            .form-card, .dashboard-card {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåü Les Petits Moulins - Syst√®me d'Autorisation</h1>
            <p>Formulaires num√©riques s√©curis√©s - Gestion familiale avanc√©e</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="parent-form">Formulaire Parent</button>
            <button class="nav-tab" data-tab="admin-dashboard">Tableau de Bord</button>
            <button class="nav-tab" data-tab="admin-parents">Gestion Parents</button>
            <button class="nav-tab" data-tab="admin-children">Gestion Enfants</button>
            <button class="nav-tab" data-tab="admin-educators">Gestion √âducateurs</button>
            <button class="nav-tab" data-tab="admin-groups">Gestion Groupes</button>
        </div>

        <!-- Parent Form Tab -->
        <div id="parent-form" class="tab-content active">
            <div class="form-card">
                <h2>Formulaire d'Autorisation Parent</h2>
                
                <!-- Email Entry -->
                <div id="email-step">
                    <div class="form-group">
                        <label for="parent-email">Votre Adresse Courriel</label>
                        <input type="email" id="parent-email" placeholder="Entrez votre adresse courriel">
                        <div id="email-error" class="error-message"></div>
                    </div>
                    <button class="btn" id="send-verification-btn">Envoyer Code de V√©rification</button>
                </div>

                <!-- Verification Code -->
                <div id="verification-step" style="display: none;">
                    <div class="success-message">
                        <strong>üìß Code de v√©rification envoy√©!</strong>
                        <br>Nous avons envoy√© un code de v√©rification √† 6 chiffres √† votre adresse courriel.
                        <br>Veuillez v√©rifier votre bo√Æte de r√©ception et vos courriers ind√©sirables.
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        <p><strong>Entrez le code de v√©rification:</strong></p>
                        <div class="verification-code-input">
                            <input type="text" maxlength="1" id="code1">
                            <input type="text" maxlength="1" id="code2">
                            <input type="text" maxlength="1" id="code3">
                            <input type="text" maxlength="1" id="code4">
                            <input type="text" maxlength="1" id="code5">
                            <input type="text" maxlength="1" id="code6">
                        </div>
                        <div id="verification-error" class="error-message"></div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button class="btn" id="verify-code-btn">V√©rifier le Code</button>
                        <button class="btn btn-secondary" id="go-back-btn">Retour</button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 15px;">
                        <p>Vous n'avez pas re√ßu le code? 
                            <button id="resend-code-btn" style="background: none; border: none; color: #3498db; text-decoration: underline; cursor: pointer;">Renvoyer le code</button>
                        </p>
                        <p id="resend-timer" style="color: #666; font-size: 12px;"></p>
                    </div>
                </div>

                <!-- Authorization Form -->
                <div id="authorization-form" style="display: none;">
                    <div class="success-message">
                        <strong>‚úÖ V√©rification r√©ussie!</strong> Compl√©tez le formulaire ci-dessous.
                    </div>
                    
                    <div id="parent-info" class="parent-info"></div>

                    <form id="auth-form">
                        <div class="form-group">
                            <label for="form-type">Type de Formulaire</label>
                            <select id="form-type" required>
                                <option value="">S√©lectionnez le type...</option>
                                <option value="field-trip">Permission de Sortie √âducative</option>
                                <option value="medical">Autorisation de Traitement M√©dical</option>
                                <option value="photo-release">Autorisation Photo/Vid√©o</option>
                                <option value="pickup-authorization">Autorisation de R√©cup√©ration</option>
                                <option value="swimming">Permission d'Activit√© de Natation</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="activity-description">Description de l'Activit√©</label>
                            <textarea id="activity-description" rows="4" placeholder="Description..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="event-date">Date de l'√âv√©nement</label>
                            <input type="date" id="event-date">
                        </div>

                        <div class="form-group">
                            <label>Enfants S√©lectionn√©s</label>
                            <div id="children-selection"></div>
                        </div>

                        <div class="checkbox-group">
                            <input type="checkbox" id="consent-given" required>
                            <label for="consent-given">Je donne mon consentement</label>
                        </div>

                        <div class="form-group">
                            <label for="additional-notes">Notes Additionnelles</label>
                            <textarea id="additional-notes" rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="digital-signature">Signature Num√©rique</label>
                            <input type="text" id="digital-signature" placeholder="Tapez votre nom complet" required>
                        </div>

                        <button type="submit" class="btn btn-success">Soumettre</button>
                        <button type="button" class="btn btn-secondary" id="reset-form-btn">R√©initialiser</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="tab-content">
            <div class="dashboard-card">
                <h2>Tableau de Bord</h2>
                <div id="dashboard-content" class="loading">Cliquez pour charger les donn√©es...</div>
            </div>
        </div>

        <!-- Gestion Parents -->
        <div id="admin-parents" class="tab-content">
            <div class="dashboard-card">
                <h2>Gestion des Parents</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn" id="show-add-parent-btn">Ajouter Parent</button>
                    <button class="btn btn-secondary" id="refresh-parents-btn">Actualiser</button>
                </div>

                <!-- Formulaire d'ajout/modification -->
                <div id="add-parent-form" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 id="parent-form-title">Ajouter Nouveau Parent</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Nom Complet</label>
                            <input type="text" id="new-parent-name" placeholder="Nom et pr√©nom">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="new-parent-email" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label>T√©l√©phone</label>
                            <input type="tel" id="new-parent-phone" placeholder="514-555-1234">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Gestion des Enfants</label>
                        <div style="margin-bottom: 15px;">
                            <button type="button" class="btn btn-info" id="associate-existing-child-btn">Associer enfant existant</button>
                            <button type="button" class="btn btn-secondary" id="create-new-child-btn">Cr√©er nouvel enfant</button>
                        </div>
                        <div id="parent-children-list"></div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" id="save-parent-btn">Ajouter</button>
                        <button class="btn btn-secondary" id="cancel-add-parent-btn">Annuler</button>
                    </div>
                </div>

                <div id="parents-table-container">
                    <div id="parents-loading" class="loading">Chargement des parents...</div>
                </div>
            </div>
        </div>

        <!-- Gestion Enfants -->
        <div id="admin-children" class="tab-content">
            <div class="dashboard-card">
                <h2>Gestion des Enfants</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn" id="show-add-child-btn">Ajouter Enfant</button>
                    <button class="btn btn-secondary" id="refresh-children-btn">Actualiser</button>
                </div>

                <!-- Formulaire d'ajout/modification enfant -->
                <div id="add-child-form" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 id="child-form-title">Ajouter Nouvel Enfant</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Nom Complet</label>
                            <input type="text" id="new-child-name" placeholder="Pr√©nom et nom">
                        </div>
                        <div class="form-group">
                            <label>√Çge</label>
                            <input type="number" id="new-child-age" min="1" max="12" placeholder="Age">
                        </div>
                        <div class="form-group">
                            <label>Date de Naissance</label>
                            <input type="date" id="new-child-birthdate">
                        </div>
                        <div class="form-group">
                            <label>Groupe</label>
                            <select id="new-child-group">
                                <option value="">S√©lectionner un groupe</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>√âducateur Principal</label>
                            <select id="new-child-educator">
                                <option value="">S√©lectionner un √©ducateur</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Allergies/Notes M√©dicales</label>
                            <textarea id="new-child-medical-notes" rows="3" placeholder="Allergies, m√©dicaments, etc."></textarea>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" id="save-child-btn">Ajouter</button>
                        <button class="btn btn-secondary" id="cancel-add-child-btn">Annuler</button>
                    </div>
                </div>

                <div id="children-table-container">
                    <div id="children-loading" class="loading">Chargement des enfants...</div>
                </div>
            </div>
        </div>

        <!-- Gestion √âducateurs -->
        <div id="admin-educators" class="tab-content">
            <div class="dashboard-card">
                <h2>Gestion des √âducateurs</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn" id="show-add-educator-btn">Ajouter √âducateur</button>
                    <button class="btn btn-secondary" id="refresh-educators-btn">Actualiser</button>
                </div>

                <!-- Formulaire d'ajout/modification -->
                <div id="add-educator-form" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 id="educator-form-title">Ajouter Nouvel √âducateur</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Nom Complet</label>
                            <input type="text" id="new-educator-name" placeholder="Nom et pr√©nom">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="new-educator-email" placeholder="email@garderie.com">
                        </div>
                        <div class="form-group">
                            <label>T√©l√©phone</label>
                            <input type="tel" id="new-educator-phone" placeholder="514-555-1234">
                        </div>
                        <div class="form-group">
                            <label>Sp√©cialisation</label>
                            <input type="text" id="new-educator-specialization" placeholder="√âducateur sp√©cialis√© petite enfance">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" id="save-educator-btn">Ajouter</button>
                        <button class="btn btn-secondary" id="cancel-add-educator-btn">Annuler</button>
                    </div>
                </div>

                <div id="educators-table-container">
                    <div id="educators-loading" class="loading">Chargement des √©ducateurs...</div>
                </div>
            </div>
        </div>

        <!-- Gestion Groupes -->
        <div id="admin-groups" class="tab-content">
            <div class="dashboard-card">
                <h2>Gestion des Groupes</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn" id="show-add-group-btn">Ajouter Groupe</button>
                    <button class="btn btn-secondary" id="refresh-groups-btn">Actualiser</button>
                </div>

                <!-- Formulaire d'ajout/modification -->
                <div id="add-group-form" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 id="group-form-title">Ajouter Nouveau Groupe</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Nom du Groupe</label>
                            <input type="text" id="new-group-name" placeholder="ex: Coccinelles">
                        </div>
                        <div class="form-group">
                            <label>√Çge Minimum</label>
                            <input type="number" id="new-group-age-min" min="1" max="12" placeholder="2">
                        </div>
                        <div class="form-group">
                            <label>√Çge Maximum</label>
                            <input type="number" id="new-group-age-max" min="1" max="12" placeholder="3">
                        </div>
                        <div class="form-group">
                            <label>Couleur</label>
                            <input type="color" id="new-group-color" value="#3498db">
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label>Description</label>
                            <input type="text" id="new-group-description" placeholder="Groupe des tout-petits">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" id="save-group-btn">Ajouter</button>
                        <button class="btn btn-secondary" id="cancel-add-group-btn">Annuler</button>
                    </div>
                </div>

                <div id="groups-table-container">
                    <div id="groups-loading" class="loading">Chargement des groupes...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration API - Remplacez par votre URL backend Render
        const API_BASE = 'https://petits-moulins-api.onrender.com/api';
        
        // Variables globales
        let authToken = localStorage.getItem('authToken');
        let currentParent = null;
        let currentParentEmail = '';
        let resendTimer = 0;
        let resendInterval = null;
        let editingParentId = null;
        let editingChildId = null;
        let editingEducatorId = null;
        let editingGroupId = null;
        let allChildren = [];
        let allEducators = [];
        let allGroups = [];

        // Descriptions des formulaires
        const formDescriptions = {
            'field-trip': 'Sortie √©ducative pr√©vue avec les enfants. Transport s√©curis√© et supervision compl√®te.',
            'medical': 'Autorisation pour administration de m√©dicaments ou soins d\'urgence.',
            'photo-release': 'Autorisation pour photos/vid√©os dans le cadre des activit√©s de la garderie.',
            'pickup-authorization': 'Autorisation pour qu\'une personne d√©sign√©e vienne chercher votre enfant.',
            'swimming': 'Autorisation pour activit√©s aquatiques avec surveillance qualifi√©e.'
        };

        // === FONCTIONS UTILITAIRES ===

        function showStatusMessage(message, type = 'info', duration = 5000) {
            const existingMessages = document.querySelectorAll('.status-message');
            existingMessages.forEach(msg => msg.remove());
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `status-message status-${type}`;
            messageDiv.innerHTML = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, duration);
        }

        async function authenticatedFetch(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (authToken) {
                headers.Authorization = `Bearer ${authToken}`;
            }
            
            return fetch(url, { ...options, headers });
        }

        function isValidEmail(email) {
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailPattern.test(email);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            
            const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
            const selectedContent = document.getElementById(tabName);
            
            if (selectedTab) selectedTab.classList.add('active');
            if (selectedContent) selectedContent.classList.add('active');
        }

        function createModal(id, content) {
            closeModal(id);
            const modalDiv = document.createElement('div');
            modalDiv.id = id;
            modalDiv.className = 'modal';
            modalDiv.innerHTML = content;
            document.body.appendChild(modalDiv);
            
            // Fermeture au clic sur le fond
            modalDiv.addEventListener('click', (e) => {
                if (e.target === modalDiv) {
                    closeModal(id);
                }
            });
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.remove();
        }

        // === FONCTIONS AUTHENTIFICATION ===

        async function handleSendVerification() {
            const email = document.getElementById('parent-email').value.trim();
            const errorDiv = document.getElementById('email-error');
            const sendBtn = document.getElementById('send-verification-btn');
            
            if (!email) {
                errorDiv.textContent = 'Veuillez entrer votre adresse courriel.';
                return;
            }

            if (!isValidEmail(email)) {
                errorDiv.textContent = 'Format d\'adresse courriel invalide.';
                return;
            }
            
            try {
                sendBtn.disabled = true;
                sendBtn.textContent = 'Envoi en cours...';
                errorDiv.textContent = '';
                
                const response = await fetch(`${API_BASE}/auth/send-verification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    errorDiv.textContent = result.error || 'Erreur lors de l\'envoi';
                    return;
                }
                
                currentParentEmail = email;
                document.getElementById('email-step').style.display = 'none';
                document.getElementById('verification-step').style.display = 'block';
                document.getElementById('code1').focus();
                
                showStatusMessage('Code de v√©rification envoy√© avec succ√®s!', 'success');
                
                if (result.dev_code) {
                    console.log('Code de v√©rification de d√©veloppement:', result.dev_code);
                    showStatusMessage(`Code de test: ${result.dev_code}`, 'info', 10000);
                }
                
                startResendTimer();
                
            } catch (error) {
                console.error('Erreur:', error);
                errorDiv.textContent = 'Erreur de connexion au serveur.';
                showStatusMessage('Erreur de connexion au serveur', 'error');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Envoyer Code de V√©rification';
            }
        }

        async function handleVerifyCode() {
            const code = ['code1', 'code2', 'code3', 'code4', 'code5', 'code6']
                .map(id => document.getElementById(id).value)
                .join('');
            
            const errorDiv = document.getElementById('verification-error');
            const verifyBtn = document.getElementById('verify-code-btn');
            
            if (code.length !== 6) {
                errorDiv.textContent = 'Veuillez entrer le code complet.';
                return;
            }
            
            try {
                verifyBtn.disabled = true;
                verifyBtn.textContent = 'V√©rification...';
                errorDiv.textContent = '';
                
                const response = await fetch(`${API_BASE}/auth/verify-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentParentEmail, code: code })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    errorDiv.textContent = result.error || 'Code incorrect';
                    ['code1', 'code2', 'code3', 'code4', 'code5', 'code6'].forEach(id => {
                        document.getElementById(id).value = '';
                    });
                    document.getElementById('code1').focus();
                    return;
                }
                
                authToken = result.token;
                localStorage.setItem('authToken', authToken);
                currentParent = result.parent;
                
                document.getElementById('verification-step').style.display = 'none';
                document.getElementById('authorization-form').style.display = 'block';
                populateParentInfo();
                
                showStatusMessage('V√©rification r√©ussie!', 'success');
                
            } catch (error) {
                console.error('Erreur:', error);
                errorDiv.textContent = 'Erreur de connexion au serveur.';
                showStatusMessage('Erreur de connexion au serveur', 'error');
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'V√©rifier le Code';
            }
        }

        function populateParentInfo() {
            if (!currentParent) return;
            
            let childrenDisplay = '';
            
            if (currentParent.children_details) {
                const details = typeof currentParent.children_details === 'string' ? 
                    JSON.parse(currentParent.children_details) : 
                    currentParent.children_details;
                
                childrenDisplay = details.map(child => {
                    return `${child.name} (${child.age} ans, ${child.group || 'Groupe non sp√©cifi√©'})`;
                }).join('<br>');
            } else if (currentParent.children) {
                const children = typeof currentParent.children === 'string' ? 
                    JSON.parse(currentParent.children) : 
                    currentParent.children;
                childrenDisplay = Array.isArray(children) ? children.join('<br>') : children;
            }
            
            document.getElementById('parent-info').innerHTML = 
                '<h4>Informations du Parent</h4>' +
                '<p><strong>Nom:</strong> ' + currentParent.name + '</p>' +
                '<p><strong>Email:</strong> ' + currentParent.email + '</p>' +
                '<p><strong>T√©l√©phone:</strong> ' + (currentParent.phone || 'Non sp√©cifi√©') + '</p>' +
                '<p><strong>Enfants:</strong><br>' + childrenDisplay + '</p>';
            
            populateChildrenSelection();
        }

        function populateChildrenSelection() {
            if (!currentParent) return;
            
            let children = [];
            
            if (currentParent.children_details) {
                const details = typeof currentParent.children_details === 'string' ? 
                    JSON.parse(currentParent.children_details) : 
                    currentParent.children_details;
                children = details.map(child => child.name);
            } else if (currentParent.children) {
                const childrenData = typeof currentParent.children === 'string' ? 
                    JSON.parse(currentParent.children) : 
                    currentParent.children;
                children = Array.isArray(childrenData) ? childrenData : [childrenData];
            }
            
            document.getElementById('children-selection').innerHTML = children.map(child => {
                const safeId = child.replace(/[^a-zA-Z0-9]/g, '-');
                return '<div class="checkbox-group">' +
                    '<input type="checkbox" id="child-' + safeId + '" value="' + child + '" checked>' +
                    '<label for="child-' + safeId + '">' + child + '</label>' +
                    '</div>';
            }).join('');
        }

        function startResendTimer() {
            resendTimer = 30;
            const timerDiv = document.getElementById('resend-timer');
            const resendBtn = document.getElementById('resend-code-btn');
            
            resendBtn.disabled = true;
            
            resendInterval = setInterval(() => {
                if (resendTimer > 0) {
                    timerDiv.textContent = `Vous pouvez renvoyer le code dans ${resendTimer} secondes`;
                    resendTimer--;
                } else {
                    timerDiv.textContent = '';
                    resendBtn.disabled = false;
                    clearInterval(resendInterval);
                }
            }, 1000);
        }

        function handleGoBack() {
            document.getElementById('verification-step').style.display = 'none';
            document.getElementById('email-step').style.display = 'block';
            ['code1', 'code2', 'code3', 'code4', 'code5', 'code6'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('verification-error').textContent = '';
            
            if (resendInterval) {
                clearInterval(resendInterval);
                resendTimer = 0;
            }
        }

        async function handleResendCode() {
            if (resendTimer > 0) return;
            await handleSendVerification();
        }

        // === FONCTIONS FORMULAIRES ===

        async function handleFormSubmit(event) {
            event.preventDefault();
            
            if (!authToken) {
                showStatusMessage('Vous devez √™tre authentifi√© pour soumettre un formulaire', 'error');
                return;
            }

            const formData = {
                form_type: document.getElementById('form-type').value,
                activity_description: document.getElementById('activity-description').value,
                event_date: document.getElementById('event-date').value,
                consent_given: document.getElementById('consent-given').checked,
                additional_notes: document.getElementById('additional-notes').value,
                digital_signature: document.getElementById('digital-signature').value,
                children: Array.from(document.querySelectorAll('#children-selection input:checked'))
                    .map(input => input.value)
            };

            try {
                const response = await authenticatedFetch(`${API_BASE}/forms/submit`, {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    showStatusMessage('Formulaire soumis avec succ√®s!', 'success');
                    document.getElementById('auth-form').reset();
                } else {
                    showStatusMessage(result.error || 'Erreur lors de la soumission', 'error');
                }
            } catch (error) {
                console.error('Erreur soumission:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        // === FONCTIONS ADMIN - DASHBOARD ===

        async function loadDashboard() {
            try {
                const dashboardContent = document.getElementById('dashboard-content');
                dashboardContent.innerHTML = '<div class="loading">Chargement des donn√©es...</div>';
                
                const response = await authenticatedFetch(`${API_BASE}/forms/all`);
                const result = await response.json();
                
                if (result.success) {
                    displayFormsTable(result.forms);
                } else {
                    dashboardContent.innerHTML = '<div class="error-message">Erreur de chargement des donn√©es</div>';
                }
            } catch (error) {
                console.error('Erreur chargement dashboard:', error);
                document.getElementById('dashboard-content').innerHTML = '<div class="error-message">Erreur de connexion</div>';
            }
        }

        function displayFormsTable(forms) {
            const dashboardContent = document.getElementById('dashboard-content');
            
            let tableHTML = `
                <h2>Tableau de Bord - ${forms.length} formulaires</h2>
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead>
                        <tr style="background: #2c3e50; color: white;">
                            <th style="padding: 12px; text-align: left;">Date</th>
                            <th style="padding: 12px; text-align: left;">Parent</th>
                            <th style="padding: 12px; text-align: left;">Type</th>
                            <th style="padding: 12px; text-align: left;">Enfants</th>
                            <th style="padding: 12px; text-align: left;">Statut</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            forms.forEach(form => {
                const children = typeof form.children === 'string' ? 
                    JSON.parse(form.children) : form.children;
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 12px;">${new Date(form.date_submitted).toLocaleDateString('fr-CA')}</td>
                        <td style="padding: 12px;">${form.parent_name}</td>
                        <td style="padding: 12px;">${form.form_type}</td>
                        <td style="padding: 12px;">${Array.isArray(children) ? children.join(', ') : children}</td>
                        <td style="padding: 12px;"><span style="color: #27ae60; font-weight: bold;">${form.status}</span></td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            dashboardContent.innerHTML = tableHTML;
        }

        // === FONCTIONS CHARGEMENT DONN√âES ===

        async function loadAllChildren() {
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/children`);
                const result = await response.json();
                allChildren = result.success ? result.children : [];
                return allChildren;
            } catch (error) {
                console.error('Erreur chargement enfants:', error);
                allChildren = [];
                return [];
            }
        }

        async function loadAllEducators() {
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/educators`);
                const result = await response.json();
                allEducators = result.success ? result.educators : [];
                return allEducators;
            } catch (error) {
                console.error('Erreur chargement √©ducateurs:', error);
                allEducators = [];
                return [];
            }
        }

        async function loadAllGroups() {
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/groups`);
                const result = await response.json();
                allGroups = result.success ? result.groups : [];
                return allGroups;
            } catch (error) {
                console.error('Erreur chargement groupes:', error);
                allGroups = [];
                return [];
            }
        }

        async function populateSelectOptions() {
            await loadAllEducators();
            await loadAllGroups();
            
            // Peupler les s√©lects d'enfants
            const childGroupSelect = document.getElementById('new-child-group');
            const childEducatorSelect = document.getElementById('new-child-educator');
            
            if (childGroupSelect) {
                childGroupSelect.innerHTML = '<option value="">S√©lectionner un groupe</option>' + 
                    allGroups.map(group => `<option value="${group.id}">${group.name} (${group.age_min}-${group.age_max} ans)</option>`).join('');
            }
            
            if (childEducatorSelect) {
                childEducatorSelect.innerHTML = '<option value="">S√©lectionner un √©ducateur</option>' + 
                    allEducators.map(educator => `<option value="${educator.id}">${educator.name}</option>`).join('');
            }
        }

        // === FONCTIONS ADMIN - PARENTS ===

        async function loadParentsAdmin() {
            if (!authToken) {
                showStatusMessage('Vous devez √™tre connect√©', 'error');
                return;
            }

            const loadingElement = document.getElementById('parents-loading');
            if (loadingElement) {
                loadingElement.style.display = 'block';
            }
            
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/parents`);
                const result = await response.json();
                
                if (result.success) {
                    displayParentsTable(result.parents);
                } else {
                    showStatusMessage('Erreur de chargement des parents', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        function displayParentsTable(parents) {
            const container = document.getElementById('parents-table-container');
            
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead>
                        <tr style="background: #2c3e50; color: white;">
                            <th style="padding: 12px; text-align: left;">Nom</th>
                            <th style="padding: 12px; text-align: left;">Email</th>
                            <th style="padding: 12px; text-align: left;">T√©l√©phone</th>
                            <th style="padding: 12px; text-align: left;">Enfants</th>
                            <th style="padding: 12px; text-align: left;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            parents.forEach(parent => {
                const children = parent.children ? 
                    (typeof parent.children === 'string' ? JSON.parse(parent.children) : parent.children) : [];
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 12px;">${parent.name}</td>
                        <td style="padding: 12px;">${parent.email}</td>
                        <td style="padding: 12px;">${parent.phone || 'Non sp√©cifi√©'}</td>
                        <td style="padding: 12px;">${Array.isArray(children) ? children.join(', ') : children}</td>
                        <td style="padding: 12px;">
                            <button class="btn btn-secondary" onclick="editParent(${parent.id})" style="padding: 5px 10px; font-size: 12px;">Modifier</button>
                            <button class="btn btn-danger" onclick="deleteParent(${parent.id})" style="padding: 5px 10px; font-size: 12px;">Supprimer</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        async function addParent() {
            const name = document.getElementById('new-parent-name').value.trim();
            const email = document.getElementById('new-parent-email').value.trim();
            const phone = document.getElementById('new-parent-phone').value.trim();
            
            if (!name || !email) {
                showStatusMessage('Nom et email sont requis', 'error');
                return;
            }
            
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/parents`, {
                    method: 'POST',
                    body: JSON.stringify({ name, email, phone })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatusMessage('Parent ajout√© avec succ√®s', 'success');
                    resetParentForm();
                    loadParentsAdmin();
                } else {
                    showStatusMessage(result.error || 'Erreur lors de l\'ajout', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        async function editParent(parentId) {
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/parents/${parentId}`);
                const result = await response.json();
                
                if (!result.success) {
                    showStatusMessage('Erreur de chargement des donn√©es', 'error');
                    return;
                }
                
                const parent = result.parent;
                editingParentId = parentId;
                
                document.getElementById('parent-form-title').textContent = 'Modifier Parent';
                document.getElementById('new-parent-name').value = parent.name;
                document.getElementById('new-parent-email').value = parent.email;
                document.getElementById('new-parent-phone').value = parent.phone || '';
                
                const saveBtn = document.getElementById('save-parent-btn');
                saveBtn.textContent = 'Modifier';
                saveBtn.onclick = updateParent;
                
                document.getElementById('add-parent-form').style.display = 'block';
                
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        async function updateParent() {
            const name = document.getElementById('new-parent-name').value.trim();
            const email = document.getElementById('new-parent-email').value.trim();
            const phone = document.getElementById('new-parent-phone').value.trim();
            
            if (!name || !email) {
                showStatusMessage('Nom et email sont requis', 'error');
                return;
            }
            
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/parents/${editingParentId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ name, email, phone })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatusMessage('Parent modifi√© avec succ√®s', 'success');
                    resetParentForm();
                    loadParentsAdmin();
                } else {
                    showStatusMessage(result.error || 'Erreur lors de la modification', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        function resetParentForm() {
            document.getElementById('add-parent-form').style.display = 'none';
            document.getElementById('parent-form-title').textContent = 'Ajouter Nouveau Parent';
            document.getElementById('new-parent-name').value = '';
            document.getElementById('new-parent-email').value = '';
            document.getElementById('new-parent-phone').value = '';
            
            const saveBtn = document.getElementById('save-parent-btn');
            saveBtn.textContent = 'Ajouter';
            saveBtn.onclick = addParent;
            
            editingParentId = null;
        }

        // === FONCTIONS ADMIN - ENFANTS ===

        async function loadChildrenAdmin() {
            if (!authToken) {
                showStatusMessage('Vous devez √™tre connect√©', 'error');
                return;
            }

            const loadingElement = document.getElementById('children-loading');
            if (loadingElement) {
                loadingElement.style.display = 'block';
            }
            
            try {
                const children = await loadAllChildren();
                displayChildrenTable(children);
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        function displayChildrenTable(children) {
            const container = document.getElementById('children-table-container');
            
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead>
                        <tr style="background: #2c3e50; color: white;">
                            <th style="padding: 12px; text-align: left;">Nom</th>
                            <th style="padding: 12px; text-align: left;">√Çge</th>
                            <th style="padding: 12px; text-align: left;">Groupe</th>
                            <th style="padding: 12px; text-align: left;">√âducateur</th>
                            <th style="padding: 12px; text-align: left;">Parents</th>
                            <th style="padding: 12px; text-align: left;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            children.forEach(child => {
                tableHTML += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 12px;">${child.name}</td>
                        <td style="padding: 12px;">${child.age} ans</td>
                        <td style="padding: 12px;">${child.group_name || 'Non assign√©'}</td>
                        <td style="padding: 12px;">${child.educator_name || 'Non assign√©'}</td>
                        <td style="padding: 12px;">${child.parent_names || 'Aucun parent associ√©'}</td>
                        <td style="padding: 12px;">
                            <button class="btn btn-secondary" onclick="editChild(${child.id})" style="padding: 5px 10px; font-size: 12px;">Modifier</button>
                            <button class="btn btn-info" onclick="manageChildParents(${child.id})" style="padding: 5px 10px; font-size: 12px;">Parents</button>
                            <button class="btn btn-danger" onclick="deleteChild(${child.id})" style="padding: 5px 10px; font-size: 12px;">Supprimer</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        async function addChild() {
            const name = document.getElementById('new-child-name').value.trim();
            const age = parseInt(document.getElementById('new-child-age').value);
            const birthdate = document.getElementById('new-child-birthdate').value;
            const groupId = document.getElementById('new-child-group').value;
            const educatorId = document.getElementById('new-child-educator').value;
            const medicalNotes = document.getElementById('new-child-medical-notes').value.trim();
            
            if (!name || !age) {
                showStatusMessage('Nom et √¢ge sont requis', 'error');
                return;
            }
            
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/children`, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        name, 
                        age, 
                        birthdate, 
                        group_id: groupId || null, 
                        educator_id: educatorId || null,
                        medical_notes: medicalNotes
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatusMessage('Enfant ajout√© avec succ√®s', 'success');
                    resetChildForm();
                    loadChildrenAdmin();
                } else {
                    showStatusMessage(result.error || 'Erreur lors de l\'ajout', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        async function editChild(childId) {
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/children/${childId}`);
                const result = await response.json();
                
                if (!result.success) {
                    showStatusMessage('Erreur de chargement des donn√©es', 'error');
                    return;
                }
                
                const child = result.child;
                editingChildId = childId;
                
                await populateSelectOptions();
                
                document.getElementById('child-form-title').textContent = 'Modifier Enfant';
                document.getElementById('new-child-name').value = child.name;
                document.getElementById('new-child-age').value = child.age;
                document.getElementById('new-child-birthdate').value = child.birthdate || '';
                document.getElementById('new-child-group').value = child.group_id || '';
                document.getElementById('new-child-educator').value = child.educator_id || '';
                document.getElementById('new-child-medical-notes').value = child.medical_notes || '';
                
                const saveBtn = document.getElementById('save-child-btn');
                saveBtn.textContent = 'Modifier';
                saveBtn.onclick = updateChild;
                
                document.getElementById('add-child-form').style.display = 'block';
                
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        async function updateChild() {
            const name = document.getElementById('new-child-name').value.trim();
            const age = parseInt(document.getElementById('new-child-age').value);
            const birthdate = document.getElementById('new-child-birthdate').value;
            const groupId = document.getElementById('new-child-group').value;
            const educatorId = document.getElementById('new-child-educator').value;
            const medicalNotes = document.getElementById('new-child-medical-notes').value.trim();
            
            if (!name || !age) {
                showStatusMessage('Nom et √¢ge sont requis', 'error');
                return;
            }
            
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/children/${editingChildId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ 
                        name, 
                        age, 
                        birthdate, 
                        group_id: groupId || null, 
                        educator_id: educatorId || null,
                        medical_notes: medicalNotes
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatusMessage('Enfant modifi√© avec succ√®s', 'success');
                    resetChildForm();
                    loadChildrenAdmin();
                } else {
                    showStatusMessage(result.error || 'Erreur lors de la modification', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        function resetChildForm() {
            document.getElementById('add-child-form').style.display = 'none';
            document.getElementById('child-form-title').textContent = 'Ajouter Nouvel Enfant';
            document.getElementById('new-child-name').value = '';
            document.getElementById('new-child-age').value = '';
            document.getElementById('new-child-birthdate').value = '';
            document.getElementById('new-child-group').value = '';
            document.getElementById('new-child-educator').value = '';
            document.getElementById('new-child-medical-notes').value = '';
            
            const saveBtn = document.getElementById('save-child-btn');
            saveBtn.textContent = 'Ajouter';
            saveBtn.onclick = addChild;
            
            editingChildId = null;
        }

        async function manageChildParents(childId) {
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/children/${childId}/parents`);
                const result = await response.json();
                
                if (!result.success) {
                    showStatusMessage('Erreur de chargement', 'error');
                    return;
                }
                
                const child = result.child;
                const parents = result.parents || [];
                const allParents = result.all_parents || [];
                
                const modalContent = `
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3>Gestion des Parents - ${child.name}</h3>
                        
                        <h4>Parents Actuels:</h4>
                        <div id="current-parents">
                            ${parents.map(parent => `
                                <div class="child-association">
                                    <div class="child-info">
                                        <strong>${parent.parent_name}</strong><br>
                                        <small>Relation: ${parent.relationship} | Garde: <span class="relationship-badge custody-${parent.custody_type}">${parent.custody_type}</span></small>
                                    </div>
                                    <button class="btn btn-danger" onclick="removeParentChild(${childId}, ${parent.parent_id})" style="padding: 3px 6px; font-size: 11px;">Retirer</button>
                                </div>
                            `).join('')}
                            ${parents.length === 0 ? '<p>Aucun parent associ√©</p>' : ''}
                        </div>
                        
                        <h4 style="margin-top: 20px;">Ajouter un Parent:</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${allParents.filter(p => !parents.some(cp => cp.parent_id === p.id)).map(parent => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                                    <div>
                                        <strong>${parent.name}</strong><br>
                                        <small>${parent.email}</small>
                                    </div>
                                    <button class="btn btn-success" onclick="showAddParentModal(${childId}, ${parent.id}, '${parent.name}')" style="padding: 5px 10px; font-size: 12px;">Associer</button>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal('child-parents-modal')">Fermer</button>
                        </div>
                    </div>
                `;
                
                createModal('child-parents-modal', modalContent);
                
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        async function showAddParentModal(childId, parentId, parentName) {
            const modalContent = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; width: 90%;">
                    <h3>Associer ${parentName}</h3>
                    <div class="form-group">
                        <label>Type de relation:</label>
                        <select id="relationship-type">
                            <option value="parent">Parent</option>
                            <option value="tuteur">Tuteur l√©gal</option>
                            <option value="gardien">Gardien</option>
                            <option value="grand-parent">Grand-parent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type de garde:</label>
                        <select id="custody-type">
                            <option value="shared">Partag√©e</option>
                            <option value="primary">Principale</option>
                            <option value="secondary">Secondaire</option>
                            <option value="weekend">Week-end uniquement</option>
                        </select>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="can-authorize" checked>
                        <label for="can-authorize">Peut donner des autorisations</label>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="associateChildParent(${childId}, ${parentId})">Associer</button>
                        <button class="btn btn-secondary" onclick="closeModal('add-parent-child-modal')">Annuler</button>
                    </div>
                </div>
            `;
            
            createModal('add-parent-child-modal', modalContent);
        }

        async function associateChildParent(childId, parentId) {
            try {
                const relationship = document.getElementById('relationship-type').value;
                const custodyType = document.getElementById('custody-type').value;
                const canAuthorize = document.getElementById('can-authorize').checked;
                
                const response = await authenticatedFetch(`${API_BASE}/admin/parent-children`, {
                    method: 'POST',
                    body: JSON.stringify({
                        parent_id: parentId,
                        child_id: childId,
                        relationship: relationship,
                        custody_type: custodyType,
                        can_authorize: canAuthorize
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatusMessage('Association cr√©√©e avec succ√®s', 'success');
                    closeModal('add-parent-child-modal');
                    closeModal('child-parents-modal');
                    loadChildrenAdmin();
                } else {
                    showStatusMessage(result.error || 'Erreur lors de l\'association', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        async function removeParentChild(childId, parentId) {
            if (!confirm('√ätes-vous s√ªr de vouloir retirer cette association parent-enfant ?')) {
                return;
            }
            
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/parent-children/${parentId}/${childId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatusMessage('Association supprim√©e', 'success');
                    manageChildParents(childId); // Recharger le modal
                } else {
                    showStatusMessage(result.error || 'Erreur lors de la suppression', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        // === FONCTIONS ADMIN - √âDUCATEURS ===

        async function loadEducatorsAdmin() {
            if (!authToken) {
                showStatusMessage('Vous devez √™tre connect√©', 'error');
                return;
            }

            const loadingElement = document.getElementById('educators-loading');
            if (loadingElement) {
                loadingElement.style.display = 'block';
            }
            
            try {
                const educators = await loadAllEducators();
                displayEducatorsTable(educators);
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        function displayEducatorsTable(educators) {
            const container = document.getElementById('educators-table-container');
            
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead>
                        <tr style="background: #2c3e50; color: white;">
                            <th style="padding: 12px; text-align: left;">Nom</th>
                            <th style="padding: 12px; text-align: left;">Email</th>
                            <th style="padding: 12px; text-align: left;">T√©l√©phone</th>
                            <th style="padding: 12px; text-align: left;">Sp√©cialisation</th>
                            <th style="padding: 12px; text-align: left;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            educators.forEach(educator => {
                tableHTML += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 12px;">${educator.name}</td>
                        <td style="padding: 12px;">${educator.email || 'Non sp√©cifi√©'}</td>
                        <td style="padding: 12px;">${educator.phone || 'Non sp√©cifi√©'}</td>
                        <td style="padding: 12px;">${educator.specialization || 'Non sp√©cifi√©'}</td>
                        <td style="padding: 12px;">
                            <button class="btn btn-secondary" onclick="editEducator(${educator.id})" style="padding: 5px 10px; font-size: 12px;">Modifier</button>
                            <button class="btn btn-danger" onclick="deleteEducator(${educator.id})" style="padding: 5px 10px; font-size: 12px;">Supprimer</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        async function addEducator() {
            const name = document.getElementById('new-educator-name').value.trim();
            const email = document.getElementById('new-educator-email').value.trim();
            const phone = document.getElementById('new-educator-phone').value.trim();
            const specialization = document.getElementById('new-educator-specialization').value.trim();
            
            if (!name) {
                showStatusMessage('Le nom est requis', 'error');
                return;
            }
            
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/educators`, {
                    method: 'POST',
                    body: JSON.stringify({ name, email, phone, specialization })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatusMessage('√âducateur ajout√© avec succ√®s', 'success');
                    resetEducatorForm();
                    loadEducatorsAdmin();
                } else {
                    showStatusMessage(result.error || 'Erreur lors de l\'ajout', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        async function editEducator(educatorId) {
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/educators/${educatorId}`);
                const result = await response.json();
                
                if (!result.success) {
                    showStatusMessage('Erreur de chargement des donn√©es', 'error');
                    return;
                }
                
                const educator = result.educator;
                editingEducatorId = educatorId;
                
                document.getElementById('educator-form-title').textContent = 'Modifier √âducateur';
                document.getElementById('new-educator-name').value = educator.name;
                document.getElementById('new-educator-email').value = educator.email || '';
                document.getElementById('new-educator-phone').value = educator.phone || '';
                document.getElementById('new-educator-specialization').value = educator.specialization || '';
                
                const saveBtn = document.getElementById('save-educator-btn');
                saveBtn.textContent = 'Modifier';
                saveBtn.onclick = updateEducator;
                
                document.getElementById('add-educator-form').style.display = 'block';
                
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        async function updateEducator() {
            const name = document.getElementById('new-educator-name').value.trim();
            const email = document.getElementById('new-educator-email').value.trim();
            const phone = document.getElementById('new-educator-phone').value.trim();
            const specialization = document.getElementById('new-educator-specialization').value.trim();
            
            if (!name) {
                showStatusMessage('Le nom est requis', 'error');
                return;
            }
            
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/educators/${editingEducatorId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ name, email, phone, specialization })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatusMessage('√âducateur modifi√© avec succ√®s', 'success');
                    resetEducatorForm();
                    loadEducatorsAdmin();
                } else {
                    showStatusMessage(result.error || 'Erreur lors de la modification', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        function resetEducatorForm() {
            document.getElementById('add-educator-form').style.display = 'none';
            document.getElementById('educator-form-title').textContent = 'Ajouter Nouvel √âducateur';
            document.getElementById('new-educator-name').value = '';
            document.getElementById('new-educator-email').value = '';
            document.getElementById('new-educator-phone').value = '';
            document.getElementById('new-educator-specialization').value = '';
            
            const saveBtn = document.getElementById('save-educator-btn');
            saveBtn.textContent = 'Ajouter';
            saveBtn.onclick = addEducator;
            
            editingEducatorId = null;
        }

        // === FONCTIONS ADMIN - GROUPES ===

        async function loadGroupsAdmin() {
            if (!authToken) {
                showStatusMessage('Vous devez √™tre connect√©', 'error');
                return;
            }

            const loadingElement = document.getElementById('groups-loading');
            if (loadingElement) {
                loadingElement.style.display = 'block';
            }
            
            try {
                const groups = await loadAllGroups();
                displayGroupsTable(groups);
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        function displayGroupsTable(groups) {
            const container = document.getElementById('groups-table-container');
            
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead>
                        <tr style="background: #2c3e50; color: white;">
                            <th style="padding: 12px; text-align: left;">Nom</th>
                            <th style="padding: 12px; text-align: left;">√Çge</th>
                            <th style="padding: 12px; text-align: left;">Description</th>
                            <th style="padding: 12px; text-align: left;">Couleur</th>
                            <th style="padding: 12px; text-align: left;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            groups.forEach(group => {
                tableHTML += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 12px;">${group.name}</td>
                        <td style="padding: 12px;">${group.age_min}-${group.age_max} ans</td>
                        <td style="padding: 12px;">${group.description || 'Aucune description'}</td>
                        <td style="padding: 12px;">
                            <div style="display: flex; align-items: center;">
                                <div style="width: 20px; height: 20px; background-color: ${group.color}; border-radius: 50%; margin-right: 10px;"></div>
                                ${group.color}
                            </div>
                        </td>
                        <td style="padding: 12px;">
                            <button class="btn btn-secondary" onclick="editGroup(${group.id})" style="padding: 5px 10px; font-size: 12px;">Modifier</button>
                            <button class="btn btn-danger" onclick="deleteGroup(${group.id})" style="padding: 5px 10px; font-size: 12px;">Supprimer</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        async function addGroup() {
            const name = document.getElementById('new-group-name').value.trim();
            const age_min = parseInt(document.getElementById('new-group-age-min').value);
            const age_max = parseInt(document.getElementById('new-group-age-max').value);
            const description = document.getElementById('new-group-description').value.trim();
            const color = document.getElementById('new-group-color').value;
            
            if (!name || !age_min || !age_max) {
                showStatusMessage('Nom et √¢ges sont requis', 'error');
                return;
            }
            
            if (age_min >= age_max) {
                showStatusMessage('L\'√¢ge minimum doit √™tre inf√©rieur √† l\'√¢ge maximum', 'error');
                return;
            }
            
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/groups`, {
                    method: 'POST',
                    body: JSON.stringify({ name, age_min, age_max, description, color })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatusMessage('Groupe ajout√© avec succ√®s', 'success');
                    resetGroupForm();
                    loadGroupsAdmin();
                } else {
                    showStatusMessage(result.error || 'Erreur lors de l\'ajout', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        async function editGroup(groupId) {
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/groups/${groupId}`);
                const result = await response.json();
                
                if (!result.success) {
                    showStatusMessage('Erreur de chargement des donn√©es', 'error');
                    return;
                }
                
                const group = result.group;
                editingGroupId = groupId;
                
                document.getElementById('group-form-title').textContent = 'Modifier Groupe';
                document.getElementById('new-group-name').value = group.name;
                document.getElementById('new-group-age-min').value = group.age_min;
                document.getElementById('new-group-age-max').value = group.age_max;
                document.getElementById('new-group-description').value = group.description || '';
                document.getElementById('new-group-color').value = group.color;
                
                const saveBtn = document.getElementById('save-group-btn');
                saveBtn.textContent = 'Modifier';
                saveBtn.onclick = updateGroup;
                
                document.getElementById('add-group-form').style.display = 'block';
                
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        async function updateGroup() {
            const name = document.getElementById('new-group-name').value.trim();
            const age_min = parseInt(document.getElementById('new-group-age-min').value);
            const age_max = parseInt(document.getElementById('new-group-age-max').value);
            const description = document.getElementById('new-group-description').value.trim();
            const color = document.getElementById('new-group-color').value;
            
            if (!name || !age_min || !age_max) {
                showStatusMessage('Nom et √¢ges sont requis', 'error');
                return;
            }
            
            if (age_min >= age_max) {
                showStatusMessage('L\'√¢ge minimum doit √™tre inf√©rieur √† l\'√¢ge maximum', 'error');
                return;
            }
            
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/groups/${editingGroupId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ name, age_min, age_max, description, color })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatusMessage('Groupe modifi√© avec succ√®s', 'success');
                    resetGroupForm();
                    loadGroupsAdmin();
                } else {
                    showStatusMessage(result.error || 'Erreur lors de la modification', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        function resetGroupForm() {
            document.getElementById('add-group-form').style.display = 'none';
            document.getElementById('group-form-title').textContent = 'Ajouter Nouveau Groupe';
            document.getElementById('new-group-name').value = '';
            document.getElementById('new-group-age-min').value = '';
            document.getElementById('new-group-age-max').value = '';
            document.getElementById('new-group-description').value = '';
            document.getElementById('new-group-color').value = '#3498db';
            
            const saveBtn = document.getElementById('save-group-btn');
            saveBtn.textContent = 'Ajouter';
            saveBtn.onclick = addGroup;
            
            editingGroupId = null;
        }

        // === FONCTIONS DE SUPPRESSION ===

        async function deleteParent(parentId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce parent ? Toutes les associations avec les enfants seront √©galement supprim√©es.')) {
                return;
            }
            
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/parents/${parentId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatusMessage('Parent supprim√© avec succ√®s', 'success');
                    loadParentsAdmin();
                } else {
                    showStatusMessage(result.error || 'Erreur lors de la suppression', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        async function deleteChild(childId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet enfant ? Toutes les associations avec les parents seront √©galement supprim√©es.')) {
                return;
            }
            
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/children/${childId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatusMessage('Enfant supprim√© avec succ√®s', 'success');
                    loadChildrenAdmin();
                } else {
                    showStatusMessage(result.error || 'Erreur lors de la suppression', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        async function deleteEducator(educatorId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet √©ducateur ?')) {
                return;
            }
            
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/educators/${educatorId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatusMessage('√âducateur supprim√© avec succ√®s', 'success');
                    loadEducatorsAdmin();
                } else {
                    showStatusMessage(result.error || 'Erreur lors de la suppression', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        async function deleteGroup(groupId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce groupe ?')) {
                return;
            }
            
            try {
                const response = await authenticatedFetch(`${API_BASE}/admin/groups/${groupId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatusMessage('Groupe supprim√© avec succ√®s', 'success');
                    loadGroupsAdmin();
                } else {
                    showStatusMessage(result.error || 'Erreur lors de la suppression', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatusMessage('Erreur de connexion', 'error');
            }
        }

        // === EVENT LISTENERS ===

        document.addEventListener('DOMContentLoaded', function() {
            // Navigation principale
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // Chargement des onglets admin
            document.querySelector('[data-tab="admin-dashboard"]')?.addEventListener('click', loadDashboard);
            document.querySelector('[data-tab="admin-parents"]')?.addEventListener('click', loadParentsAdmin);
            document.querySelector('[data-tab="admin-children"]')?.addEventListener('click', () => {
                loadChildrenAdmin();
                populateSelectOptions();
            });
            document.querySelector('[data-tab="admin-educators"]')?.addEventListener('click', loadEducatorsAdmin);
            document.querySelector('[data-tab="admin-groups"]')?.addEventListener('click', loadGroupsAdmin);

            // Authentification
            document.getElementById('send-verification-btn')?.addEventListener('click', handleSendVerification);
            document.getElementById('verify-code-btn')?.addEventListener('click', handleVerifyCode);
            document.getElementById('go-back-btn')?.addEventListener('click', handleGoBack);
            document.getElementById('resend-code-btn')?.addEventListener('click', handleResendCode);
            
            // Navigation entre les champs de code
            document.querySelectorAll('#verification-step input').forEach((input, index) => {
                input.addEventListener('input', () => {
                    if (input.value.length === input.maxLength) {
                        const nextInput = document.getElementById('code' + (index + 2));
                        if (nextInput) {
                            nextInput.focus();
                        } else {
                            setTimeout(handleVerifyCode, 100);
                        }
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && input.value === '') {
                        const prevInput = document.getElementById('code' + index);
                        if (prevInput) {
                            prevInput.focus();
                        }
                    }
                });
            });

            // Formulaire parent
            document.getElementById('form-type')?.addEventListener('change', () => {
                const formType = document.getElementById('form-type').value;
                const descriptionField = document.getElementById('activity-description');
                if (formDescriptions[formType] && descriptionField) {
                    descriptionField.value = formDescriptions[formType];
                }
            });

            document.getElementById('auth-form')?.addEventListener('submit', handleFormSubmit);
            document.getElementById('reset-form-btn')?.addEventListener('click', () => {
                document.getElementById('auth-form')?.reset();
            });

            document.getElementById('parent-email')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSendVerification();
                }
            });

            // Gestion Parents
            document.getElementById('show-add-parent-btn')?.addEventListener('click', () => {
                document.getElementById('add-parent-form').style.display = 'block';
            });
            document.getElementById('cancel-add-parent-btn')?.addEventListener('click', resetParentForm);
            document.getElementById('save-parent-btn')?.addEventListener('click', addParent);
            document.getElementById('refresh-parents-btn')?.addEventListener('click', loadParentsAdmin);

            // Gestion Enfants
            document.getElementById('show-add-child-btn')?.addEventListener('click', () => {
                populateSelectOptions();
                document.getElementById('add-child-form').style.display = 'block';
            });
            document.getElementById('cancel-add-child-btn')?.addEventListener('click', resetChildForm);
            document.getElementById('save-child-btn')?.addEventListener('click', addChild);
            document.getElementById('refresh-children-btn')?.addEventListener('click', loadChildrenAdmin);

            // Gestion √âducateurs
            document.getElementById('show-add-educator-btn')?.addEventListener('click', () => {
                document.getElementById('add-educator-form').style.display = 'block';
            });
            document.getElementById('cancel-add-educator-btn')?.addEventListener('click', resetEducatorForm);
            document.getElementById('save-educator-btn')?.addEventListener('click', addEducator);
            document.getElementById('refresh-educators-btn')?.addEventListener('click', loadEducatorsAdmin);

            // Gestion Groupes
            document.getElementById('show-add-group-btn')?.addEventListener('click', () => {
                document.getElementById('add-group-form').style.display = 'block';
            });
            document.getElementById('cancel-add-group-btn')?.addEventListener('click', resetGroupForm);
            document.getElementById('save-group-btn')?.addEventListener('click', addGroup);
            document.getElementById('refresh-groups-btn')?.addEventListener('click', loadGroupsAdmin);
        });

        // V√©rifier si l'utilisateur est d√©j√† authentifi√© au chargement
        if (authToken) {
            console.log('Token d\'authentification trouv√©');
        }
    </script>
</body>
</html>
                
                